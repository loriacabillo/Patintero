<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Patintero Game</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
html,body { 
  height: 100%; 
  margin:0; 
  padding:0; 
}
body {
  font-family: "Press Start 2P", cursive;
  background: url("patintero-bg.png") no-repeat center center fixed;
  background-size: cover;
  overflow: hidden;
}

/* overlay card, UI, joystick, sprites etc (kept mostly as you had) */
.overlay-card {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 90vw;
  max-width: 600px;
  background: rgba(0,0,0,0.2);
  backdrop-filter: blur(5px);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 5vw;
  z-index: 100;
}

.overlay-card h2 {
  margin-top: 0;
  color: yellow;
  font-size: 5vw;
  letter-spacing: 2px;
  text-shadow: 2px 2px 0 #000;
}

.overlay-card p {
  font-size: 3vw;
  margin: 5vw 0;
  line-height: 1.6em;
  color: #fff;
  text-shadow: 1px 1px 0 #000;
  max-width: 90vw;
}

.overlay-card ul { text-align: left; color: #fff; font-size: 2.5vw; max-width: 80%; margin: 2vw 0; list-style: none; padding: 0; }
.overlay-card li { margin: 1vw 0; text-shadow: 1px 1px 0 #000; }
.overlay-card input { padding: 3vw; font-size: 3vw; width: 70%; margin: 2vw 0; border: 2px solid #fff; border-radius: 8px; background: rgba(255,255,255,0.9); font-family: inherit; text-align: center; }

#startBtn, .submit-btn, #leaderboardBtn {
  padding: 3vw 6vw;
  font-size: 3vw;
  background: #2196f3;
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.18s ease;
  box-shadow: 0 4px 0 #0d47a1;
  z-index: 101;
  pointer-events: auto;
  margin: 2vw 0;
}
#leaderboardBtn { background: #4caf50; box-shadow: 0 4px 0 #388e3c; }
#startBtn:hover, .submit-btn:hover, #leaderboardBtn:hover { transform: scale(1.06); }
#leaderboardBtn:hover { background: #45a049; }

/* UI Elements */
.top-ui { position: fixed; top: 10px; z-index: 1000; color: white; text-shadow: 1px 1px 0 black; font-size: clamp(8px, 2vw, 16px); line-height: 1.2; }
#ui-left { left: 10px; }
#ui-right { right: 10px; text-align: right; }
#ui-right h3 { color: yellow; font-size: clamp(12px, 4vw, 24px); margin: 0; letter-spacing: 2px; }

/* Joystick Styles */
#joystick { position: fixed; bottom: 20px; left: 20px; width: 100px; height: 100px; background: rgba(255, 255, 255, 0.18); border: 2px solid rgba(255, 255, 255, 0.28); border-radius: 50%; z-index: 999; pointer-events: auto; display: none; transition: opacity 0.3s ease; }
#knob { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; background: rgba(255, 255, 255, 0.7); border: 2px solid rgba(255, 255, 255, 0.9); border-radius: 50%; transform: translate(-50%, -50%); transition: transform 0.08s ease; }

/* Level Complete Announcement */
#levelCompleteOverlay {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 80vw;
  max-width: 400px;
  background: rgba(0, 255, 0, 0.88);
  color: white;
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  z-index: 1001;
  display: none;
  font-size: 4vw;
  font-family: "Press Start 2P", cursive;
  text-shadow: 1px 1px 0 black;
}

/* CHARACTER SPRITE SYSTEM */
:root { --pixel-size: 2; }
.Character { width: calc(32px * var(--pixel-size)); height: calc(32px * var(--pixel-size)); overflow: hidden; position: absolute; transform: translate(-50%, -50%); pointer-events: none; }
.Character img { display: block; background: transparent; }
.Character_spritesheet { animation: moveSpritesheet 1s steps(4) infinite; width: calc(128px * var(--pixel-size)); position: absolute; left: 0; top: 0; }
.Character_shadow { position: absolute; width: calc(32px * var(--pixel-size)); height: calc(32px * var(--pixel-size)); left: 0; top: 0; opacity: 0.9; }

.pixelart { image-rendering: pixelated; }

.face-down { top: 0; }
.face-right { top: calc(-32px * var(--pixel-size)); }
.face-up { top: calc(-64px * var(--pixel-size)); }
.face-left { top: calc(-96px * var(--pixel-size)); }

@keyframes moveSpritesheet { from { transform: translate3d(0px,0,0) } to { transform: translate3d(-100%,0,0) } }

/* FINISH LINE STYLE (reduced glow so it won‚Äôt block text) */
.finish-line {
  position: absolute;
  left: 0;
  width: 100%;
  height: 6px;
  background: linear-gradient(to right, #ff0000, #ffff00, #00ff00);
  animation: pulseGlow 1.5s infinite alternate;
  box-shadow: 0 0 6px rgba(255,255,0,0.4);
  z-index: 400;
  transform: translateY(-50%);
}
@keyframes pulseGlow {
  from { opacity: 0.4; box-shadow: 0 0 3px rgba(255,255,0,0.3); }
  to   { opacity: 0.8; box-shadow: 0 0 8px rgba(255,255,0,0.5); }
}

/* small responsiveness */
@media (max-width:600px) {
  .overlay-card { padding: 6vw; }
  .overlay-card h2 { font-size: 6vw; }
}
</style>
</head>
<body>
<!-- Home Screen -->
<div class="overlay-card" id="homeScreen">
  <h2>Patintero</h2>
  <p>
    üèÉ Relive the excitement of a Filipino
    childhood favorite! Cross the lines and avoid the taggers.<br><br>
    üëâ Use <b>ARROW KEYS / WASD</b> on desktop or <b>VIRTUAL JOYSTICK</b> on mobile to move.<br>
    üèÅ Reach the opposite side without being tagged!
  </p>
  <button id="startBtn">‚ñ∂ START GAME</button>
  <button id="leaderboardBtn">üèÜ Leaderboard</button>
</div>

<!-- Level Complete -->
<div id="levelCompleteOverlay">
  <h2 id="completeMessage">Level Complete!</h2>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const startBtn = document.getElementById("startBtn");
  const leaderboardBtn = document.getElementById("leaderboardBtn");

  let playerName = '';
  let currentLevel = 1;
  const maxLevel = 5;
  let gameEnded = false;

  // screen dims (initialized in initGame)
  let screenW = window.innerWidth;
  let screenH = window.innerHeight;

  // game elements state
  let blockers = [];
  let linesY = [];
  let finishLine = null;

  // joystick state
  let joystickActive = false;
  let joystickCenterX = 0;
  let joystickCenterY = 0;
  let currentDx = 0;
  let currentDy = 0;
  let joystickInterval = null;

  // Leaderboard helpers (localStorage)
  function getLeaderboard() {
    return JSON.parse(localStorage.getItem('patinteroLeaderboard') || '[]');
  }
  function saveLeaderboard(leaderboard) {
    localStorage.setItem('patinteroLeaderboard', JSON.stringify(leaderboard));
  }
  function updatePlayerScore(name, levelsCompleted) {
    if (!name) return;
    let lb = getLeaderboard();
    const completed = Math.max(0, Math.floor(levelsCompleted));
    let existing = lb.find(p => p.name.toLowerCase() === name.toLowerCase());
    if (existing) {
      if (completed > existing.levelsCompleted) existing.levelsCompleted = completed;
    } else {
      lb.push({ name: name, levelsCompleted: completed });
    }
    lb.sort((a, b) => b.levelsCompleted - a.levelsCompleted || a.name.localeCompare(b.name));
    saveLeaderboard(lb);
  }

  function showLeaderboard(showHomeAfter = false) {
    const lb = getLeaderboard();
    const top10 = lb.slice(0, 10);
    let html = '<h2>üèÜ Leaderboard</h2><p>Top 10 Players by Levels Completed</p><ul>';
    if (top10.length === 0) html += '<li>No scores yet!</li>';
    else top10.forEach((p,i) => html += `<li>${i+1}. ${p.name} - ${p.levelsCompleted} Levels</li>`);
    html += '</ul><button class="submit-btn" id="closeLb">Close</button>';
    const lbOverlay = document.createElement("div");
    lbOverlay.className = "overlay-card";
    lbOverlay.id = "lbOverlay";
    lbOverlay.innerHTML = html;
    document.body.appendChild(lbOverlay);
    document.getElementById("closeLb").addEventListener("click", () => {
      lbOverlay.remove();
      if (showHomeAfter) {
        document.getElementById("homeScreen").style.display = "flex";
      } else {
        // restore game over or win overlay if exists
        const gameOverOverlay = document.getElementById("gameOverOverlay");
        const winOverlay = document.getElementById("winOverlay");
        if (gameOverOverlay) gameOverOverlay.style.display = "flex";
        if (winOverlay) winOverlay.style.display = "flex";
      }
    });
  }

  leaderboardBtn.addEventListener("click", () => showLeaderboard(false));


  // Start flow: ask for player name then init game
  startBtn.addEventListener("click", () => {
    document.getElementById("homeScreen").style.display = "none";

    const nameOverlay = document.createElement("div");
    nameOverlay.className = "overlay-card";
    nameOverlay.id = "nameOverlay";
    nameOverlay.innerHTML = `
      <h2>Enter Player Name</h2>
      <p>To start the game, please enter your username.</p>
      <input id="username" type="text" placeholder="Your Name" maxlength="20">
      <button class="submit-btn" id="submitName">‚ñ∂ START GAME</button>
    `;
    document.body.appendChild(nameOverlay);

    const submitNameBtn = document.getElementById("submitName");
    const usernameInput = document.getElementById("username");

    submitNameBtn.addEventListener("click", () => {
      const name = usernameInput.value.trim();
      if (!name) { alert("Please enter a username to start the game!"); return; }
      playerName = name;
      localStorage.setItem('patinteroPlayer', JSON.stringify({ name: playerName }));
      nameOverlay.remove();
      initGame();
    });

    usernameInput.addEventListener("keypress", (e) => { if (e.key === "Enter") submitNameBtn.click(); });
  });

  function initGame() {
    // update screen dims
    screenW = window.innerWidth;
    screenH = window.innerHeight;

    document.body.style.background = "url('playground.png') no-repeat center center fixed";
    document.body.style.backgroundSize = "cover";

    // top UI
    const uiLeft = document.createElement("div");
    uiLeft.id = "ui-left";
    uiLeft.className = "top-ui";
    uiLeft.innerHTML = '<div id="playerInfo"></div>';
    document.body.appendChild(uiLeft);

    const uiRight = document.createElement("div");
    uiRight.id = "ui-right";
    uiRight.className = "top-ui";
    uiRight.innerHTML = '<h3>PATINTERO</h3>';
    document.body.appendChild(uiRight);

    updatePlayerInfo();

    // lines from bottom to top (5 lines)
    linesY = [
      screenH * 0.75,
      screenH * 0.60,
      screenH * 0.45,
      screenH * 0.30,
      screenH * 0.15
    ];

    // player constants
    const PLAYER_SIZE = 64;

    // create player element
    const player = document.createElement("div");
    player.className = "Character";
    let x = screenW * 0.5;
    let y = screenH - 100;
    player.style.left = x + "px";
    player.style.top = y + "px";
    player.setAttribute("facing", "down");
    player.innerHTML = `
      <img class="Character_shadow pixelart" src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/21542/DemoRpgCharacterShadow.png" />
      <img class="Character_spritesheet pixelart face-down" src="AjFP5.png" />
    `;
    document.body.appendChild(player);

    // create blockers and finish line
    createBlockersForLevel(currentLevel);
    createFinishLine(currentLevel);

    // joystick for touch
    const joystick = document.createElement('div');
    joystick.id = 'joystick';
    const knob = document.createElement('div');
    knob.id = 'knob';
    joystick.appendChild(knob);
    document.body.appendChild(joystick);

    // show joystick on touch devices
    const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    if (isTouch) joystick.style.display = 'block';

    const joystickElement = document.getElementById('joystick');
    const knobElement = document.getElementById('knob');

    joystickElement.addEventListener('touchstart', (e) => {
      if (gameEnded) return;
      e.preventDefault();
      joystickActive = true;
      const rect = joystickElement.getBoundingClientRect();
      joystickCenterX = rect.left + rect.width / 2;
      joystickCenterY = rect.top + rect.height / 2;
      updateKnob(e.touches[0].clientX, e.touches[0].clientY);
      startJoystickMovement();
    }, { passive: false });

    joystickElement.addEventListener('touchmove', (e) => {
      if (!joystickActive || gameEnded) return;
      e.preventDefault();
      updateKnob(e.touches[0].clientX, e.touches[0].clientY);
    }, { passive: false });

    joystickElement.addEventListener('touchend', (e) => {
      if (gameEnded) return;
      e.preventDefault();
      joystickActive = false;
      currentDx = 0;
      currentDy = 0;
      knobElement.style.transform = 'translate(-50%, -50%)';
      stopJoystickMovement();
    }, { passive: false });

    function updateKnob(touchX, touchY) {
      const deltaX = touchX - joystickCenterX;
      const deltaY = touchY - joystickCenterY;
      const dist = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
      const maxDist = 30;
      let normalizedDx = 0;
      let normalizedDy = 0;
      if (dist > maxDist) {
        const angle = Math.atan2(deltaY, deltaX);
        const clampedX = Math.cos(angle) * maxDist;
        const clampedY = Math.sin(angle) * maxDist;
        normalizedDx = clampedX / maxDist;
        normalizedDy = clampedY / maxDist;
        knobElement.style.transform = `translate(-50%, -50%) translate(${clampedX}px, ${clampedY}px)`;
      } else {
        normalizedDx = deltaX / maxDist;
        normalizedDy = deltaY / maxDist;
        knobElement.style.transform = `translate(-50%, -50%) translate(${deltaX}px, ${deltaY}px)`;
      }
      currentDx = normalizedDx;
      currentDy = normalizedDy;
    }

    function startJoystickMovement() {
      if (joystickInterval) clearInterval(joystickInterval);
      joystickInterval = setInterval(() => {
        if (!joystickActive || gameEnded) { stopJoystickMovement(); return; }
        moveBasedOnJoystick();
      }, 120);
    }
    function stopJoystickMovement() { if (joystickInterval) clearInterval(joystickInterval); }

    function moveBasedOnJoystick() {
      const moveX = Math.round(currentDx * 20);
      const moveY = Math.round(currentDy * 20);
      if (moveX === 0 && moveY === 0) return;
      movePlayer(moveX, moveY);
    }

    // keyboard
    document.addEventListener("keydown", (e) => {
      if (gameEnded) return;
      switch (e.key.toLowerCase()) {
        case "arrowup":
        case "w": movePlayer(0, -20); break;
        case "arrowdown":
        case "s": movePlayer(0, 20); break;
        case "arrowleft":
        case "a": movePlayer(-20, 0); break;
        case "arrowright":
        case "d": movePlayer(20, 0); break;
      }
    });

    function movePlayer(dx, dy) {
      x += dx; y += dy;
      x = Math.max(0, Math.min(x, screenW));
      y = Math.max(0, Math.min(y, screenH));
      player.style.left = x + "px";
      player.style.top = y + "px";
      if (dy < 0) player.setAttribute("facing", "up");
      else if (dy > 0) player.setAttribute("facing", "down");
      else if (dx < 0) player.setAttribute("facing", "left");
      else if (dx > 0) player.setAttribute("facing", "right");

      checkCollisions();
      checkLevelComplete();
    }

    function checkCollisions() {
      const playerRect = player.getBoundingClientRect();
      for (let b of blockers) {
        const bRect = b.getBoundingClientRect();
        if (!(playerRect.right < bRect.left || playerRect.left > bRect.right || playerRect.bottom < bRect.top || playerRect.top > bRect.bottom)) {
          gameOver();
          return;
        }
      }
    }

    function checkLevelComplete() {
      if (!finishLine) return;
      const playerRect = player.getBoundingClientRect();
      const finishRect = finishLine.getBoundingClientRect();
      if (!(playerRect.right < finishRect.left || playerRect.left > finishRect.right || playerRect.bottom < finishRect.top || playerRect.top > finishRect.bottom)) {
        levelComplete();
      }
    }

    function updatePlayerInfo() {
      const infoDiv = document.getElementById("playerInfo");
      infoDiv.textContent = playerName ? `Player: ${playerName} | Level: ${currentLevel}` : `Level: ${currentLevel}`;
    }

    function createBlockersForLevel(level) {
      blockers.forEach(b => b.remove());
      blockers = [];
      linesY.forEach((lineY, index) => {
        const blocker = document.createElement("div");
        blocker.className = "Character";
        blocker.innerHTML = `
          <img class="Character_shadow pixelart" src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/21542/DemoRpgCharacterShadow.png" />
          <img class="Character_spritesheet pixelart face-right" src="blocker.png" />
        `;
        blocker.style.left = (screenW * 0.5) + "px";
        blocker.style.top = lineY + "px";
        document.body.appendChild(blocker);
        blockers.push(blocker);
        const speed = 3 + level + index;
        animateBlocker(blocker, speed);
      });
    }

    function animateBlocker(blocker, speed) {
      let direction = Math.random() < 0.5 ? 1 : -1;
      function move() {
        if (gameEnded) return;
        let left = parseInt(blocker.style.left);
        left += direction * speed;
        if (left < 50 || left > screenW - 50) {
          direction *= -1;
        }
        blocker.style.left = left + "px";
        requestAnimationFrame(move);
      }
      move();
    }

    function createFinishLine(level) {
      if (finishLine) finishLine.remove();
      finishLine = document.createElement("div");
      finishLine.className = "finish-line";
      finishLine.style.top = (screenH * 0.1) + "px";
      document.body.appendChild(finishLine);
    }

    function levelComplete() {
      currentLevel++;
      if (currentLevel > maxLevel) { winGame(); return; }
      showLevelComplete();
      createBlockersForLevel(currentLevel);
      createFinishLine(currentLevel);
      updatePlayerInfo();
      x = screenW * 0.5;
      y = screenH - 100;
      player.style.left = x + "px";
      player.style.top = y + "px";
    }

    function showLevelComplete() {
      const overlay = document.getElementById("levelCompleteOverlay");
      const messageEl = document.getElementById("completeMessage");
      if (currentLevel === 1) {
        messageEl.textContent = `Complete: Level ${currentLevel}`;
      } else {
        messageEl.textContent = `Complete: Level ${currentLevel}s`;
      }
      overlay.style.display = "block";
      setTimeout(() => { overlay.style.display = "none"; }, 2000);
    }

    function gameOver() {
      if (gameEnded) return;
      gameEnded = true;
      updatePlayerScore(playerName, currentLevel - 1);
      const overlay = document.createElement("div");
      overlay.className = "overlay-card";
      overlay.id = "gameOverOverlay";
      overlay.innerHTML = `<h2>Game Over</h2><p>You reached Level ${currentLevel}</p>
        <button class="submit-btn" id="restartBtn">Restart</button>
        <button class="submit-btn" id="lbBtn">Leaderboard</button>`;
      document.body.appendChild(overlay);
      document.getElementById("restartBtn").addEventListener("click", () => { location.reload(); });
      document.getElementById("lbBtn").addEventListener("click", () => {
        overlay.style.display = "none";
        showLeaderboard(false);
      });
    }

    function winGame() {
      if (gameEnded) return;
      gameEnded = true;
      updatePlayerScore(playerName, maxLevel);
      const overlay = document.createElement("div");
      overlay.className = "overlay-card";
      overlay.id = "winOverlay";
      overlay.innerHTML = `<h2>You Win!</h2><p>Congratulations, ${playerName}!</p>
        <button class="submit-btn" id="restartBtn2">Restart</button>
        <button class="submit-btn" id="lbBtn2">Leaderboard</button>`;
      document.body.appendChild(overlay);
      document.getElementById("restartBtn2").addEventListener("click", () => { location.reload(); });
      document.getElementById("lbBtn2").addEventListener("click", () => {
        overlay.style.display = "none";
        showLeaderboard(false);
      });
    }

  } // end initGame

}); // end DOMContentLoaded
</script>
</body>
</html>
